name: Deploy without build

on:
    # Trigger after staging deployment completes successfully
    workflow_run:
        workflows: ["Deploy to Staging"]
        types:
            - completed
        branches:
            - main
    # Allow manual triggering for production deployments
    workflow_dispatch:

jobs:
    deploy-production:
        name: Deploy to Production
        runs-on: ubuntu-latest
        timeout-minutes: 35
        # Only run if the triggering workflow succeeded
        if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
        environment:
            name: production
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  # If triggered by workflow_run, use that commit; otherwise use current branch
                  ref: ${{ github.event.workflow_run.head_sha || github.ref }}
            
            - name: Copy files to production EC2
              uses: appleboy/scp-action@v0.1.4
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USER }}
                  key: ${{ secrets.EC2_SSH_KEY }}
                  port: ${{ secrets.EC2_PORT || 22 }}
                  source: "."
                  target: "/home/${{ secrets.EC2_USER }}/app-production"
                  strip_components: 0
            
            - name: Build and deploy to production
              uses: appleboy/ssh-action@v0.1.5
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USER }}
                  key: ${{ secrets.EC2_SSH_KEY }}
                  port: ${{ secrets.EC2_PORT || 22 }}
                  command_timeout: 30m
                  script: |
                      cd /home/${{ secrets.EC2_USER }}/app-production
                      
                      # Pull latest changes if it's a git repo
                      git pull origin main 2>/dev/null || echo "Not a git repo, using copied files"
                      
                      # Build and deploy with Docker
                      echo "=== Stopping existing containers ==="
                      docker-compose down || true
                      
                      echo "=== Building Docker image on EC2 ==="
                      docker-compose build --no-cache
                      
                      echo "=== Starting containers ==="
                      docker-compose up -d
                      
                      echo "=== Cleaning up old images ==="
                      docker image prune -f
                      
                      echo "=== Current running containers ==="
                      docker-compose ps
            
            - name: Health check production
              uses: appleboy/ssh-action@v0.1.5
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USER }}
                  key: ${{ secrets.EC2_SSH_KEY }}
                  port: ${{ secrets.EC2_PORT || 22 }}
                  script: |
                      echo "Waiting for application to start..."
                      sleep 15
                      
                      echo "Running health check..."
                      curl -f http://localhost:3000 || exit 1
                      
                      echo "âœ… Production deployment successful!"